{"version":3,"sources":["toc/plugin.js"],"names":["prefix","counter","global","tinymce","util","Tools","resolve","global$1","global$2","global$3","getTocClass","editor","getParam","getTocHeader","tagName","test","tocId","guid","Date","getTime","toString","readHeaders","tocClass","headerTag","selector","depth","i","push","join","generateSelector","parseInt","getTocDepth","headers","$","length","filter","el","dom","hasClass","parentNode","map","h","id","level","nodeName","replace","title","text","element","generateTocContentHtml","ii","nextLevel","tag","closeTag","html","prevLevel","minLevel","getMinLevel","translate","DOM","encode","insertToc","$tocElm","nodes","getParents","isEmptyOrOffscren","updateToc","insertContent","generateTocHtml","undoManager","transact","toggleState","api","toggleDisabledState","setDisabled","mode","isReadOnly","hasHeaders","on","isToc","elm","is","getBody","contains","add","addCommand","register","ui","registry","addButton","icon","tooltip","onAction","execCommand","onSetup","addMenuItem","addContextToolbar","items","predicate","scope","position","register$1","e","node","removeAttr","find","attr","children","setup"],"mappings":"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","file":"plugin.js","sourcesContent":["/**\n * Copyright (c) Tiny Technologies, Inc. All rights reserved.\n * Licensed under the LGPL or a commercial license.\n * For LGPL see License.txt in the project root for license information.\n * For commercial licenses see https://www.tiny.cloud/\n *\n * Version: 5.6.2 (2020-12-08)\n */\n(function () {\n    'use strict';\n\n    var global = tinymce.util.Tools.resolve('tinymce.PluginManager');\n\n    var global$1 = tinymce.util.Tools.resolve('tinymce.dom.DOMUtils');\n\n    var global$2 = tinymce.util.Tools.resolve('tinymce.util.I18n');\n\n    var global$3 = tinymce.util.Tools.resolve('tinymce.util.Tools');\n\n    var getTocClass = function (editor) {\n      return editor.getParam('toc_class', 'mce-toc');\n    };\n    var getTocHeader = function (editor) {\n      var tagName = editor.getParam('toc_header', 'h2');\n      return /^h[1-6]$/.test(tagName) ? tagName : 'h2';\n    };\n    var getTocDepth = function (editor) {\n      var depth = parseInt(editor.getParam('toc_depth', '3'), 10);\n      return depth >= 1 && depth <= 9 ? depth : 3;\n    };\n\n    var create = function (prefix) {\n      var counter = 0;\n      return function () {\n        var guid = new Date().getTime().toString(32);\n        return prefix + guid + (counter++).toString(32);\n      };\n    };\n\n    var tocId = create('mcetoc_');\n    var generateSelector = function (depth) {\n      var i;\n      var selector = [];\n      for (i = 1; i <= depth; i++) {\n        selector.push('h' + i);\n      }\n      return selector.join(',');\n    };\n    var hasHeaders = function (editor) {\n      return readHeaders(editor).length > 0;\n    };\n    var readHeaders = function (editor) {\n      var tocClass = getTocClass(editor);\n      var headerTag = getTocHeader(editor);\n      var selector = generateSelector(getTocDepth(editor));\n      var headers = editor.$(selector);\n      if (headers.length && /^h[1-9]$/i.test(headerTag)) {\n        headers = headers.filter(function (i, el) {\n          return !editor.dom.hasClass(el.parentNode, tocClass);\n        });\n      }\n      return global$3.map(headers, function (h) {\n        var id = h.id;\n        return {\n          id: id ? id : tocId(),\n          level: parseInt(h.nodeName.replace(/^H/i, ''), 10),\n          title: editor.$.text(h),\n          element: h\n        };\n      });\n    };\n    var getMinLevel = function (headers) {\n      var i, minLevel = 9;\n      for (i = 0; i < headers.length; i++) {\n        if (headers[i].level < minLevel) {\n          minLevel = headers[i].level;\n        }\n        if (minLevel === 1) {\n          return minLevel;\n        }\n      }\n      return minLevel;\n    };\n    var generateTitle = function (tag, title) {\n      var openTag = '<' + tag + ' contenteditable=\"true\">';\n      var closeTag = '</' + tag + '>';\n      return openTag + global$1.DOM.encode(title) + closeTag;\n    };\n    var generateTocHtml = function (editor) {\n      var html = generateTocContentHtml(editor);\n      return '<div class=\"' + editor.dom.encode(getTocClass(editor)) + '\" contenteditable=\"false\">' + html + '</div>';\n    };\n    var generateTocContentHtml = function (editor) {\n      var html = '';\n      var headers = readHeaders(editor);\n      var prevLevel = getMinLevel(headers) - 1;\n      var i, ii, h, nextLevel;\n      if (!headers.length) {\n        return '';\n      }\n      html += generateTitle(getTocHeader(editor), global$2.translate('Table of Contents'));\n      for (i = 0; i < headers.length; i++) {\n        h = headers[i];\n        h.element.id = h.id;\n        nextLevel = headers[i + 1] && headers[i + 1].level;\n        if (prevLevel === h.level) {\n          html += '<li>';\n        } else {\n          for (ii = prevLevel; ii < h.level; ii++) {\n            html += '<ul><li>';\n          }\n        }\n        html += '<a href=\"#' + h.id + '\">' + h.title + '</a>';\n        if (nextLevel === h.level || !nextLevel) {\n          html += '</li>';\n          if (!nextLevel) {\n            html += '</ul>';\n          }\n        } else {\n          for (ii = h.level; ii > nextLevel; ii--) {\n            html += '</li></ul><li>';\n          }\n        }\n        prevLevel = h.level;\n      }\n      return html;\n    };\n    var isEmptyOrOffscren = function (editor, nodes) {\n      return !nodes.length || editor.dom.getParents(nodes[0], '.mce-offscreen-selection').length > 0;\n    };\n    var insertToc = function (editor) {\n      var tocClass = getTocClass(editor);\n      var $tocElm = editor.$('.' + tocClass);\n      if (isEmptyOrOffscren(editor, $tocElm)) {\n        editor.insertContent(generateTocHtml(editor));\n      } else {\n        updateToc(editor);\n      }\n    };\n    var updateToc = function (editor) {\n      var tocClass = getTocClass(editor);\n      var $tocElm = editor.$('.' + tocClass);\n      if ($tocElm.length) {\n        editor.undoManager.transact(function () {\n          $tocElm.html(generateTocContentHtml(editor));\n        });\n      }\n    };\n\n    var register = function (editor) {\n      editor.addCommand('mceInsertToc', function () {\n        insertToc(editor);\n      });\n      editor.addCommand('mceUpdateToc', function () {\n        updateToc(editor);\n      });\n    };\n\n    var setup = function (editor) {\n      var $ = editor.$, tocClass = getTocClass(editor);\n      editor.on('PreProcess', function (e) {\n        var $tocElm = $('.' + tocClass, e.node);\n        if ($tocElm.length) {\n          $tocElm.removeAttr('contentEditable');\n          $tocElm.find('[contenteditable]').removeAttr('contentEditable');\n        }\n      });\n      editor.on('SetContent', function () {\n        var $tocElm = $('.' + tocClass);\n        if ($tocElm.length) {\n          $tocElm.attr('contentEditable', false);\n          $tocElm.children(':first-child').attr('contentEditable', true);\n        }\n      });\n    };\n\n    var toggleState = function (editor) {\n      return function (api) {\n        var toggleDisabledState = function () {\n          return api.setDisabled(editor.mode.isReadOnly() || !hasHeaders(editor));\n        };\n        toggleDisabledState();\n        editor.on('LoadContent SetContent change', toggleDisabledState);\n        return function () {\n          return editor.on('LoadContent SetContent change', toggleDisabledState);\n        };\n      };\n    };\n    var isToc = function (editor) {\n      return function (elm) {\n        return elm && editor.dom.is(elm, '.' + getTocClass(editor)) && editor.getBody().contains(elm);\n      };\n    };\n    var register$1 = function (editor) {\n      editor.ui.registry.addButton('toc', {\n        icon: 'toc',\n        tooltip: 'Table of contents',\n        onAction: function () {\n          return editor.execCommand('mceInsertToc');\n        },\n        onSetup: toggleState(editor)\n      });\n      editor.ui.registry.addButton('tocupdate', {\n        icon: 'reload',\n        tooltip: 'Update',\n        onAction: function () {\n          return editor.execCommand('mceUpdateToc');\n        }\n      });\n      editor.ui.registry.addMenuItem('toc', {\n        icon: 'toc',\n        text: 'Table of contents',\n        onAction: function () {\n          return editor.execCommand('mceInsertToc');\n        },\n        onSetup: toggleState(editor)\n      });\n      editor.ui.registry.addContextToolbar('toc', {\n        items: 'tocupdate',\n        predicate: isToc(editor),\n        scope: 'node',\n        position: 'node'\n      });\n    };\n\n    function Plugin () {\n      global.add('toc', function (editor) {\n        register(editor);\n        register$1(editor);\n        setup(editor);\n      });\n    }\n\n    Plugin();\n\n}());\n"]}